<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PROYAX Admin — Full SPA</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f3f6fb;
      --primary:#1f78ff;
      --accent:#ff8a00;
      --muted:#6b7280;
      --sidebar-w:260px;
      --topbar-h:68px;
      --radius:10px;
    }
    html,body{
      height:100%;
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg);
      color:#0f172a;
    }
    *{ box-sizing:border-box }

    /* APP LAYOUT */
    .app{
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    /* SIDEBAR */
    .sidebar{
      width:var(--sidebar-w);
      padding:18px;
      background:linear-gradient(180deg,#fbfdff,#f8fbff);
      border-right:1px solid rgba(15,23,42,0.04);
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .logo-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mark{
      width:44px;
      height:44px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--primary),#6aa8ff);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
    }
    nav{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:8px;
    }
    .nav-item{
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      color:var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
      font-size:15px;
    }
    .nav-item.active{
      background:rgba(31,120,255,0.08);
      color:var(--primary);
      font-weight:700;
    }
    .nav-item .material-icons{
      font-size:20px;
    }
    .side-foot{
      margin-top:auto;
      font-size:12px;
      color:var(--muted);
    }

    /* MAIN */
    .main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      height:var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 20px;
      border-bottom:1px solid rgba(15,23,42,0.04);
      background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.4));
      backdrop-filter:blur(4px);
    }
    .search{
      display:flex;
      align-items:center;
      gap:12px;
      flex:1;
      max-width:820px;
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(90deg,#fff,#fbfdff);
      font-size:14px;
    }
    .actions{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .btn{
      background:var(--primary);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn.secondary{
      background:#fff;
      color:var(--muted);
      border:1px solid #eef3ff;
    }
    .btn.danger{
      background:#ff4d4d;
      color:#fff;
    }

    .content{
      flex:1;
      overflow:auto;
      padding:18px;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }

    h1,h2{ margin:0 }

    /* DASHBOARD TILES */
    .tiles{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:16px;
      margin-top:14px;
      margin-bottom:18px;
    }
    .tile{
      background:#fff;
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,0.05);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .tile .label{ color:var(--muted); font-size:13px }
    .tile .value{ font-size:32px; font-weight:900; color:var(--primary) }
    .tile .mini{ font-size:12px; color:var(--muted) }

    /* CARDS */
    .card{
      background:#fff;
      padding:14px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.03);
    }

    /* TABLES */
    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
    }
    .table th, .table td{
      padding:10px;
      border-bottom:1px solid rgba(15,23,42,0.06);
      text-align:left;
      font-size:14px;
    }
    .table thead th{
      color:var(--muted);
      font-weight:700;
    }

    /* MOCK BUILDER UI */
    .builder-top{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:12px;
    }
    .builder-row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .input, .select{
      padding:10px;
      border-radius:8px;
      border:1px solid #e3e9f5;
      background:#fff;
      font-size:14px;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:8px;
      margin-top:12px;
    }
    .tab{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,0.08);
      cursor:pointer;
      background:#fff;
      font-weight:700;
      font-size:14px;
    }
    .tab.active{
      background:linear-gradient(90deg,#fff7f2,#fff1e6);
      color:var(--primary);
    }

    .qid{ font-weight:900 }
    .small-muted{ font-size:12px; color:var(--muted) }

    .preview-thumb{
      max-width:120px;
      max-height:60px;
      object-fit:contain;
      border-radius:6px;
      border:1px solid #e5ecf7;
      padding:2px;
      background:#fff;
    }

    /* RESPONSIVE */
    @media (max-width:1100px){
      .tiles{ grid-template-columns:repeat(2,1fr) }
      .sidebar{ display:none }
    }
    @media (max-width:700px){
      .tiles{ grid-template-columns:1fr }
      .topbar{ padding:8px }
      .builder-row{ flex-direction:column; align-items:stretch }
    }
  </style>
</head>

<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" role="navigation" aria-label="Main Navigation">
    <div class="logo-row">
      <div class="mark">PX</div>
      <div>
        <div style="font-weight:800">PROYAX Admin</div>
        <div class="small-muted">Mock & User Manager</div>
      </div>
    </div>

    <nav id="nav">
      <div class="nav-item active" data-view="dashboard">
        <span class="material-icons">dashboard</span> Dashboard
      </div>
      <div class="nav-item" data-view="mocks">
        <span class="material-icons">assignment</span> Mocks
      </div>
      <div class="nav-item" data-view="builder">
        <span class="material-icons">build_circle</span> Mock Builder
      </div>
      <div class="nav-item" data-view="users">
        <span class="material-icons">people</span> Users
      </div>
      <div class="nav-item" data-view="results">
        <span class="material-icons">bar_chart</span> Results
      </div>
      <div class="nav-item" data-view="settings">
        <span class="material-icons">settings</span> Settings
      </div>
    </nav>

    <div class="side-foot">
      <strong id="admin-name">Admin</strong>
      <div class="small-muted">superuser</div>
    </div>
  </aside>

  <!-- MAIN PANEL -->
  <main class="main">
    <div class="topbar">
      <div class="search">
        <span class="material-icons" style="color:var(--muted)">search</span>
        <input id="global-search" placeholder="Search mocks, users, results..."/>
      </div>

      <div class="actions">
        <button class="btn secondary" id="btn-refresh">Refresh</button>
        <button class="btn" id="btn-new-mock">New Mock</button>
      </div>
    </div>

    <!-- CONTENT AREA -->
    <div class="content" id="content-area">

      <!-- ============================
           DASHBOARD VIEW
      ============================= -->
      <section id="view-dashboard">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h1>Dashboard</h1>
            <div class="muted">System overview & statistics</div>
          </div>
          <div class="small-muted" id="dashboard-updated">—</div>
        </div>

        <div class="tiles">
          <div class="tile">
            <div class="label">Total Users</div>
            <div class="value" id="dash-users">0</div>
            <div class="mini">Registered accounts</div>
          </div>

          <div class="tile">
            <div class="label">Total Mocks</div>
            <div class="value" id="dash-mocks">0</div>
            <div class="mini">Active & inactive mocks</div>
          </div>

          <div class="tile">
            <div class="label">Total Attempts</div>
            <div class="value" id="dash-attempts">0</div>
            <div class="mini">Submissions saved</div>
          </div>
        </div>

        <div class="card">
          <h2 style="font-size:16px;margin:0">Quick Actions</h2>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="go-mocks">Manage Mocks</button>
            <button class="btn" id="go-users">Manage Users</button>
            <button class="btn secondary" id="go-results">View Results</button>
          </div>
        </div>
      </section>

      <!-- ============================
           MOCKS LIST VIEW
      ============================= -->
      <section id="view-mocks" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h1>Mocks</h1>
            <div class="muted">All created mock tests</div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <input id="filter-mocks" class="input" placeholder="Filter mocks..." style="width:200px"/>
            <button class="btn" id="btn-create-mock">Create Mock</button>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <table class="table" id="mocks-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Questions</th>
                <th>Time (min)</th>
                <th>Active</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- ============================
           MOCK BUILDER VIEW
      ============================= -->
      <section id="view-builder" style="display:none;">
        <h1>Mock Builder</h1>
        <div class="muted" style="margin-top:6px">Create or edit mock tests. Auto-generate P/C/M rows.</div>

        <div class="card" style="margin-top:12px">
          <div class="builder-top">

            <!-- TOP FIELDS -->
            <div class="builder-row">
              <div class="field" style="min-width:260px">
                <label class="small-muted">Mock Name *</label>
                <input id="mock-name" class="input" placeholder="Mock Name"/>
              </div>

              <div class="field">
                <label class="small-muted">Total Questions *</label>
                <input id="mock-qns" type="number" class="input" style="width:120px" value="60"/>
              </div>

              <div class="field">
                <label class="small-muted">Duration (min)</label>
                <input id="mock-duration" type="number" class="input" style="width:120px" value="120"/>
              </div>

              <div class="field">
                <label class="small-muted">Active</label>
                <select id="mock-active" class="select" style="width:120px">
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div style="display:flex;gap:8px;align-items:flex-end">
                <button class="btn" id="btn-generate">Generate Rows</button>
                <button class="btn secondary" id="btn-clear">Clear</button>
              </div>
            </div>

            <!-- SUBJECT TABS -->
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
              <div>
                <div class="tabs">
                  <div class="tab active" data-sub="Physics" id="tab-physics">Physics</div>
                  <div class="tab" data-sub="Chemistry" id="tab-chem">Chemistry</div>
                  <div class="tab" data-sub="Mathematics" id="tab-math">Mathematics</div>
                </div>
                <div class="small-muted" style="margin-top:6px">Auto-generated QIDs (P1, C1, M1...)</div>
              </div>

              <div style="display:flex;gap:8px">
                <button class="btn" id="save-mock">Save Mock</button>
                <button class="btn secondary" id="save-and-close">Save & Close</button>
              </div>
            </div>

          </div>

          <!-- SUBJECT TABLES -->
          <div id="builder-area" style="margin-top:14px">

            <!-- Physics -->
            <div id="table-Physics" class="subject-table" style="display:block;">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:80px">QID</th>
                    <th>Image Link</th>
                    <th style="width:140px">Answer</th>
                    <th style="width:120px">Preview</th>
                    <th style="width:140px">Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody-Physics"></tbody>
              </table>
            </div>

            <!-- Chemistry -->
            <div id="table-Chemistry" class="subject-table" style="display:none;">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:80px">QID</th>
                    <th>Image Link</th>
                    <th style="width:140px">Answer</th>
                    <th style="width:120px">Preview</th>
                    <th style="width:140px">Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody-Chemistry"></tbody>
              </table>
            </div>

            <!-- Mathematics -->
            <div id="table-Mathematatics" class="subject-table" style="display:none;">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width:80px">QID</th>
                    <th>Image Link</th>
                    <th style="width:140px">Answer</th>
                    <th style="width:120px">Preview</th>
                    <th style="width:140px">Actions</th>
                  </tr>
                </thead>
                <tbody id="tbody-Mathematics"></tbody>
              </table>
            </div>

          </div>

          <div id="builder-status" class="small-muted" style="margin-top:8px"></div>
        </div>
      </section>
      <!-- ============================
           USERS VIEW
      ============================= -->
      <section id="view-users" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h1>Users</h1>
            <div class="muted">Manage student & admin accounts</div>
          </div>

          <button class="btn" id="btn-add-user">Add User</button>
        </div>

        <div class="card" style="margin-top:14px">
          <table class="table" id="users-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Name</th>
                <th>Role</th>
                <th>Created</th>
                <th style="width:160px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>


      <!-- ============================
           RESULTS VIEW
      ============================= -->
      <section id="view-results" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div>
            <h1>Results</h1>
            <div class="muted">Student attempts & scores</div>
          </div>

          <input class="input" id="filter-results" placeholder="Filter results..." style="width:220px"/>
        </div>

        <div class="card" style="margin-top:14px">
          <table class="table" id="results-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Mock</th>
                <th>Score</th>
                <th>Date</th>
                <th>Duration</th>
                <th style="width:140px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>


      <!-- ============================
           SETTINGS VIEW
      ============================= -->
      <section id="view-settings" style="display:none;">
        <h1>Settings</h1>
        <div class="muted" style="margin-bottom:14px">Configure system behavior and admin preferences</div>

        <div class="card">
          <h2 style="font-size:16px;margin:0">Admin Information</h2>

          <div style="margin-top:12px">
            <label class="small-muted">Admin Display Name</label>
            <input id="setting-admin-name" class="input" style="max-width:260px" placeholder="Admin Name"/>

            <button class="btn" id="save-settings" style="margin-top:10px">Save</button>
          </div>

          <hr style="margin:20px 0;border:0;border-bottom:1px solid rgba(15,23,42,0.06)">

          <h2 style="font-size:16px;margin:0">Theme</h2>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <select id="setting-theme" class="select" style="width:200px">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>

            <button class="btn secondary" id="apply-theme">Apply</button>
          </div>
        </div>
      </section>


      <!-- ============================
           MODALS (Add User + View Attempt)
      ============================= -->

      <!-- ADD USER MODAL -->
      <div id="modal-add-user" style="
        display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35);
        align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(4px);
      ">
        <div style="
          background:#fff; padding:20px; border-radius:12px; width:400px;
          max-width:92%; box-shadow:0 24px 60px rgba(0,0,0,0.15);
        ">
          <h2 style="margin:0;font-size:18px">Add User</h2>
          <div class="muted">Create a new login account</div>

          <div style="display:flex;flex-direction:column;gap:12px;margin-top:14px">
            <div class="field">
              <label class="small-muted">Username</label>
              <input id="new-user-username" class="input" placeholder="username123"/>
            </div>

            <div class="field">
              <label class="small-muted">Name</label>
              <input id="new-user-name" class="input" placeholder="Full Name"/>
            </div>

            <div class="field">
              <label class="small-muted">Password</label>
              <input id="new-user-password" type="password" class="input" placeholder="••••••••"/>
            </div>

            <div class="field">
              <label class="small-muted">Role</label>
              <select id="new-user-role" class="select">
                <option value="student">Student</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:18px">
            <button class="btn secondary" id="close-add-user">Cancel</button>
            <button class="btn" id="create-user">Create</button>
          </div>

          <div id="add-user-status" class="small-muted" style="margin-top:8px"></div>
        </div>
      </div>


      <!-- VIEW RESULT MODAL -->
      <div id="modal-attempt" style="
        display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35);
        align-items:center; justify-content:center; z-index:2000; backdrop-filter:blur(4px);
      ">
        <div style="
          background:#fff; padding:20px; border-radius:12px; width:600px;
          max-width:95%; max-height:90vh; overflow:auto;
          box-shadow:0 24px 60px rgba(0,0,0,0.15);
        ">
          <h2 style="margin:0;font-size:18px">Attempt Details</h2>
          <div class="muted" style="margin-bottom:10px">Per-question performance</div>

          <div id="attempt-details"></div>

          <div style="display:flex;justify-content:flex-end;margin-top:14px">
            <button class="btn secondary" id="close-attempt">Close</button>
          </div>
        </div>
      </div>

    </div> <!-- /content -->
  </main>
</div> <!-- /app -->

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<script>
/* =========================
   FIREBASE CONFIG
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
  authDomain: "aahes-cee-cutoffs.firebaseapp.com",
  projectId: "aahes-cee-cutoffs"
};
let db = null;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log('Firestore initialized');
} catch (e) {
  console.warn('Firestore init failed', e);
}

/* =========================
   SPA ROUTING + VIEW SWITCH
   ========================= */
const views = {
  dashboard: document.getElementById('view-dashboard'),
  mocks: document.getElementById('view-mocks'),
  builder: document.getElementById('view-builder'),
  users: document.getElementById('view-users'),
  results: document.getElementById('view-results'),
  settings: document.getElementById('view-settings')
};

function showView(name){
  Object.values(views).forEach(v => v.style.display = 'none');
  if(!views[name]) return;
  views[name].style.display = '';
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.view===name));
  // load data for the view
  if(name === 'dashboard') loadDashboard();
  if(name === 'mocks') loadMocksList();
  if(name === 'users') loadUsers();
  if(name === 'results') loadResults();
  if(name === 'settings') loadSettings();
}
document.querySelectorAll('.nav-item').forEach(n => n.addEventListener('click', ()=> showView(n.dataset.view)));

// quick nav buttons
document.getElementById('btn-refresh').addEventListener('click', ()=>{
  const active = document.querySelector('.nav-item.active').dataset.view;
  showView(active);
});
document.getElementById('go-mocks')?.addEventListener('click', ()=> showView('mocks'));
document.getElementById('go-users')?.addEventListener('click', ()=> showView('users'));
document.getElementById('go-results')?.addEventListener('click', ()=> showView('results'));
document.getElementById('btn-new-mock')?.addEventListener('click', ()=> showView('builder'));
document.getElementById('btn-create-mock')?.addEventListener('click', ()=> showView('builder'));

/* =========================
   DASHBOARD
   ========================= */
async function loadDashboard(){
  document.getElementById('dashboard-updated').textContent = new Date().toLocaleString();
  if(!db){
    document.getElementById('dash-users').textContent='—';
    document.getElementById('dash-mocks').textContent='—';
    document.getElementById('dash-attempts').textContent='—';
    return;
  }
  try{
    const [mocksSnap, usersSnap, resSnap] = await Promise.all([
      db.collection('mocks').get(),
      db.collection('users').get(),
      db.collection('res').get()
    ]);
    document.getElementById('dash-users').textContent = usersSnap.size;
    document.getElementById('dash-mocks').textContent = mocksSnap.size;
    document.getElementById('dash-attempts').textContent = resSnap.size;
  }catch(e){ console.error('loadDashboard', e); }
}

/* =========================
   MOCKS LIST
   ========================= */
const mocksTableBody = document.querySelector('#mocks-table tbody');
async function loadMocksList(){
  if(!mocksTableBody) return;
  mocksTableBody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;
  if(!db){ mocksTableBody.innerHTML = `<tr><td colspan="5">No DB configured</td></tr>`; return; }
  try{
    const snap = await db.collection('mocks').orderBy('name').get();
    mocksTableBody.innerHTML = '';
    if(snap.empty){ mocksTableBody.innerHTML = '<tr><td colspan="5">No mocks found.</td></tr>'; return; }
    snap.forEach(doc => {
      const m = doc.data(); m.id = doc.id;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td style="font-weight:800">${escapeHtml(m.name||m.id)}</td>
                      <td>${m.qns||'-'}</td>
                      <td>${m.time||m.duration||'-'}</td>
                      <td>${(m.active==='yes' || m.active===true) ? 'Yes' : 'No'}</td>
                      <td style="text-align:right"></td>`;
      const td = tr.cells[4];
      const toggle = document.createElement('button'); toggle.className='btn secondary'; toggle.textContent = (m.active==='yes' || m.active===true) ? 'Unpublish' : 'Publish';
      toggle.onclick = async ()=> {
        try{
          await db.collection('mocks').doc(m.id).update({ active: (m.active==='yes' || m.active===true) ? 'no' : 'yes' });
          loadMocksList();
        }catch(e){ console.error(e); alert('Failed to update status'); }
      };
      const edit = document.createElement('button'); edit.className='btn secondary'; edit.textContent='Edit'; edit.onclick = ()=> openMockInBuilder(m.id);
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete'; del.onclick = async ()=> {
        if(!confirm('Delete this mock and its questions?')) return;
        try{
          const qSnap = await db.collection('mocks').doc(m.id).collection('questions').get();
          for(const d of qSnap.docs) await d.ref.delete().catch(()=>{});
          await db.collection('mocks').doc(m.id).delete();
          loadMocksList();
        }catch(e){ console.error(e); alert('Delete failed'); }
      };
      td.appendChild(toggle); td.appendChild(edit); td.appendChild(del);
      mocksTableBody.appendChild(tr);
    });
  }catch(e){ console.error('loadMocksList', e); mocksTableBody.innerHTML = `<tr><td colspan="5">Failed to load mocks</td></tr>`; }
}

/* =========================
   MOCK BUILDER
   ========================= */
// state
const subjects = { Physics: [], Chemistry: [], Mathematics: [] };
let editingMockId = null;

// dom refs
const mockNameEl = document.getElementById('mock-name');
const mockQnsEl = document.getElementById('mock-qns');
const mockDurationEl = document.getElementById('mock-duration');
const mockActiveEl = document.getElementById('mock-active');
const btnGenerate = document.getElementById('btn-generate');
const btnClear = document.getElementById('btn-clear');
const saveMockBtn = document.getElementById('save-mock');
const saveAndCloseBtn = document.getElementById('save-and-close');
const builderStatus = document.getElementById('builder-status');

// helper: escape html for safety when inserting text nodes
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]; }); }

// show/hide subject table by matching tbody id (robust against container id typos)
function showSubjectTable(sub){
  const tbodyId = `tbody-${sub}`;
  document.querySelectorAll('.subject-table').forEach(tbl => {
    if(tbl.querySelector(`#${tbodyId}`)) tbl.style.display = 'block'; else tbl.style.display = 'none';
  });
  // also toggle active class on tabs
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.sub === sub));
}
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', ()=> showSubjectTable(t.dataset.sub));
});

// render tables
function renderAllTables(){ ['Physics','Chemistry','Mathematics'].forEach(s => renderTableFor(s)); }

function renderTableFor(subject){
  const tbody = document.getElementById('tbody-' + subject);
  if(!tbody) return;
  tbody.innerHTML = '';
  const arr = subjects[subject];
  if(!arr.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" class="small-muted" style="padding:14px">No questions. Click Generate Rows to create rows for each subject.</td>`;
    tbody.appendChild(tr);
    return;
  }
  arr.forEach((r, idx) => {
    const tr = document.createElement('tr');
    const imgId = `img-${subject}-${idx}`;
    const ansId = `ans-${subject}-${idx}`;
    tr.innerHTML = `
      <td class="qid">${escapeHtml(r.qid)}</td>
      <td><input id="${imgId}" class="input" value="${escapeHtml(r.imageUrl||'')}" placeholder="https://..." /></td>
      <td>
        <select id="${ansId}" class="select">
          <option value=""></option>
          <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
        </select>
      </td>
      <td style="text-align:center"><button class="btn secondary" data-idx="${idx}" data-sub="${subject}" data-act="preview">Preview</button></td>
      <td style="text-align:right">
        <button class="btn danger" data-idx="${idx}" data-sub="${subject}" data-act="remove">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
    const sel = document.getElementById(ansId);
    sel.value = r.answer || '';
    // wire actions (Preview & Remove)
    tr.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const act = b.dataset.act, i = Number(b.dataset.idx), sub = b.dataset.sub;
        if(act === 'preview'){
          const url = document.getElementById(`img-${sub}-${i}`).value.trim() || subjects[sub][i].imageUrl;
          if(!url) return alert('No image link to preview');
          const w = window.open('','preview','width=900,height=700');
          w.document.write(`<div style="padding:12px"><img src="${escapeHtml(url)}" style="max-width:100%;height:auto" /></div>`);
        } else if(act === 'remove'){
          if(!confirm('Remove this question?')) return;
          subjects[sub].splice(i,1);
          subjects[sub].forEach((q,j)=> q.qid = sub[0] + String(j+1));
          renderTableFor(sub);
        }
      });
    });
  });
}

// builder controls
btnGenerate.addEventListener('click', (e) => {
  e.preventDefault();
  const name = mockNameEl.value.trim();
  const qns = parseInt(mockQnsEl.value,10);
  if(!name){ alert('Enter mock name first'); return; }
  if(!qns || qns <= 0){ alert('Enter a valid total questions count (>0)'); return; }
  subjects.Physics = []; subjects.Chemistry = []; subjects.Mathematics = [];
  const per = Math.floor(qns/3);
  const rem = qns - per*3;
  for(let i=0;i<per;i++) subjects.Physics.push({ qid:`P${subjects.Physics.length+1}`, imageUrl:'', answer:'' });
  for(let i=0;i<per;i++) subjects.Chemistry.push({ qid:`C${subjects.Chemistry.length+1}`, imageUrl:'', answer:'' });
  for(let i=0;i<per;i++) subjects.Mathematics.push({ qid:`M${subjects.Mathematics.length+1}`, imageUrl:'', answer:'' });
  if(rem >= 1) subjects.Physics.push({ qid:`P${subjects.Physics.length+1}`, imageUrl:'', answer:'' });
  if(rem >= 2) subjects.Chemistry.push({ qid:`C${subjects.Chemistry.length+1}`, imageUrl:'', answer:'' });
  subjects.Physics.forEach((q,i)=> q.qid='P'+String(i+1));
  subjects.Chemistry.forEach((q,i)=> q.qid='C'+String(i+1));
  subjects.Mathematics.forEach((q,i)=> q.qid='M'+String(i+1));
  renderAllTables();
  showBuilderStatus(`Generated ${qns} rows (${per} per subject + ${rem} remainder)`);
});

btnClear.addEventListener('click', (e) => {
  e.preventDefault();
  if(!confirm('Clear all generated rows and fields?')) return;
  mockNameEl.value=''; mockQnsEl.value='60'; mockDurationEl.value='120'; mockActiveEl.value='yes';
  subjects.Physics=[]; subjects.Chemistry=[]; subjects.Mathematics=[];
  renderAllTables();
  showBuilderStatus('Cleared');
});

function showBuilderStatus(msg, ttl=2000){
  builderStatus.textContent = msg;
  if(ttl>0) setTimeout(()=> builderStatus.textContent = '', ttl);
}

/* =========================
   SAVE MOCK (new or edit)
   - If editingMockId present: use set(..., {merge:true}) to create/update safely
   - If no editingMockId: add new doc
   - Write questions subcollection after clearing old entries
   ========================= */
async function saveMock(closeAfter=false){
  const name = mockNameEl.value.trim();
  if(!name){ alert('Mock name is required'); return; }
  const qns = Number(mockQnsEl.value) || (subjects.Physics.length + subjects.Chemistry.length + subjects.Mathematics.length);
  const time = Number(mockDurationEl.value) || 120;
  const active = mockActiveEl.value || 'yes';

  // BEFORE SAVING: sync subjects[] arrays with current DOM input values
  ['Physics','Chemistry','Mathematics'].forEach(sub=>{
    for(let i=0;i<subjects[sub].length;i++){
      const imgInput = document.getElementById(`img-${sub}-${i}`);
      const ansSelect = document.getElementById(`ans-${sub}-${i}`);
      if(imgInput) subjects[sub][i].imageUrl = imgInput.value.trim();
      if(ansSelect) subjects[sub][i].answer = ansSelect.value || '';
    }
  });

  const legacy = { name, qns, time, active, updatedAt: firebase && firebase.firestore ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString() };
  subjects.Physics.forEach((r,i)=> { legacy[`img_p${i+1}`] = r.imageUrl || ''; legacy[`ans_p${i+1}`] = r.answer || ''; });
  subjects.Chemistry.forEach((r,i)=> { legacy[`img_c${i+1}`] = r.imageUrl || ''; legacy[`ans_c${i+1}`] = r.answer || ''; });
  subjects.Mathematics.forEach((r,i)=> { legacy[`img_m${i+1}`] = r.imageUrl || ''; legacy[`ans_m${i+1}`] = r.answer || ''; });

  // check incomplete rows
  const checkIncomplete = arr => arr.some(x => !x.imageUrl || !x.answer);
  const incomplete = checkIncomplete(subjects.Physics) || checkIncomplete(subjects.Chemistry) || checkIncomplete(subjects.Mathematics);
  if(incomplete && !confirm('Some rows are missing image link or answer. Save anyway?')) return;

  if(!db){
    console.log('No DB — would save legacy doc:', legacy);
    alert('No Firestore configured — check console.');
    if(closeAfter) location.reload();
    return;
  }

  try{
    let mockRef;
    if(editingMockId){
      mockRef = db.collection('mocks').doc(editingMockId);
      await mockRef.set(legacy, { merge: true });
    } else {
      mockRef = await db.collection('mocks').add(legacy);
      editingMockId = mockRef.id;
    }

    // build allQuestions linear list (Physics -> Chemistry -> Mathematics)
    const allQs = [];
    subjects.Physics.forEach((r,i)=> allQs.push({ qid:`P${i+1}`, section:'Physics', imageUrl:r.imageUrl||null, answer:r.answer||null, index: allQs.length+1 }));
    subjects.Chemistry.forEach((r,i)=> allQs.push({ qid:`C${i+1}`, section:'Chemistry', imageUrl:r.imageUrl||null, answer:r.answer||null, index: allQs.length+1 }));
    subjects.Mathematics.forEach((r,i)=> allQs.push({ qid:`M${i+1}`, section:'Mathematics', imageUrl:r.imageUrl||null, answer:r.answer||null, index: allQs.length+1 }));

    // delete existing questions docs if any
    try{
      const existing = await mockRef.collection('questions').get().catch(()=>({ docs: [] }));
      if(existing && existing.docs && existing.docs.length){
        for(const d of existing.docs) { try{ await d.ref.delete(); }catch(e){ console.warn('delete old q', e); } }
      }
    }catch(e){ console.warn('remove existing questions failed', e); }

    // batch write new questions
    const batch = db.batch ? db.batch() : null;
    for(let i=0;i<allQs.length;i++){
      const qRef = mockRef.collection('questions').doc(String(i+1));
      if(batch) batch.set(qRef, allQs[i]); else await qRef.set(allQs[i]);
    }
    if(batch) await batch.commit();

    showBuilderStatus(`Saved mock "${name}" (${allQs.length} questions).`, 4000);
    if(closeAfter) { alert('Saved. Returning to mocks list.'); editingMockId=null; showView('mocks'); }
    // refresh mocks list
    loadMocksList();
  }catch(err){
    console.error('saveMock error:', err);
    alert('Save failed: ' + (err && err.message ? err.message : String(err)));
  }
}
saveMockBtn.addEventListener('click', (e)=> { e.preventDefault(); saveMock(false); });
saveAndCloseBtn.addEventListener('click', (e)=> { e.preventDefault(); saveMock(true); });

/* =========================
   OPEN MOCK IN BUILDER (edit)
   ========================= */
async function openMockInBuilder(mockId){
  if(!db) return alert('Firestore not configured');
  try{
    const doc = await db.collection('mocks').doc(mockId).get();
    if(!doc.exists) return alert('Mock not found');
    const m = doc.data();
    editingMockId = mockId;
    mockNameEl.value = m.name || '';
    mockQnsEl.value = m.qns || 60;
    mockDurationEl.value = m.time || m.duration || 120;
    mockActiveEl.value = m.active || 'yes';

    subjects.Physics=[]; subjects.Chemistry=[]; subjects.Mathematics=[];
    // load legacy fields
    let i=1;
    while(m.hasOwnProperty(`img_p${i}`) || m.hasOwnProperty(`ans_p${i}`)){
      subjects.Physics.push({ qid:`P${i}`, imageUrl: m[`img_p${i}`] || '', answer: m[`ans_p${i}`] || '' });
      i++;
    }
    i=1;
    while(m.hasOwnProperty(`img_c${i}`) || m.hasOwnProperty(`ans_c${i}`)){
      subjects.Chemistry.push({ qid:`C${i}`, imageUrl: m[`img_c${i}`] || '', answer: m[`ans_c${i}`] || '' });
      i++;
    }
    i=1;
    while(m.hasOwnProperty(`img_m${i}`) || m.hasOwnProperty(`ans_m${i}`)){
      subjects.Mathematics.push({ qid:`M${i}`, imageUrl: m[`img_m${i}`] || '', answer: m[`ans_m${i}`] || '' });
      i++;
    }

    // fallback: if legacy empty use subcollection
    if(subjects.Physics.length + subjects.Chemistry.length + subjects.Mathematics.length === 0){
      const qSnap = await db.collection('mocks').doc(mockId).collection('questions').orderBy('index').get();
      qSnap.docs.forEach(d=>{
        const data = d.data();
        const sec = (data.section||'').toLowerCase();
        if(sec.startsWith('p')) subjects.Physics.push({ qid: data.qid || `P${subjects.Physics.length+1}`, imageUrl: data.imageUrl||'', answer: data.answer||'' });
        else if(sec.startsWith('c')) subjects.Chemistry.push({ qid: data.qid || `C${subjects.Chemistry.length+1}`, imageUrl: data.imageUrl||'', answer: data.answer||'' });
        else subjects.Mathematics.push({ qid: data.qid || `M${subjects.Mathematics.length+1}`, imageUrl: data.imageUrl||'', answer: data.answer||'' });
      });
    }

    showView('builder');
    // activate physics tab by default
    showSubjectTable('Physics');
    renderAllTables();
    showBuilderStatus(`Loaded mock "${m.name||mockId}"`);
  }catch(e){ console.error('openMockInBuilder', e); alert('Failed to load mock: ' + (e.message||e)); }
}

/* =========================
   USERS
   ========================= */
const usersTableBody = document.querySelector('#users-table tbody');
async function loadUsers(){
  if(!usersTableBody) return;
  usersTableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
  if(!db){ usersTableBody.innerHTML = '<tr><td colspan="5">No DB configured</td></tr>'; return; }
  try{
    const snap = await db.collection('users').orderBy('username').get();
    usersTableBody.innerHTML = '';
    if(snap.empty){ usersTableBody.innerHTML = '<tr><td colspan="5">No users</td></tr>'; return; }
    snap.forEach(doc => {
      const u = doc.data(); u.id = doc.id;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(u.username||'-')}</td><td>${escapeHtml(u.name||'-')}</td><td>${escapeHtml(u.role||'student')}</td><td>${u.createdAt && u.createdAt.toDate ? u.createdAt.toDate().toLocaleString() : '-'}</td><td></td>`;
      const td = tr.cells[4];
      const toggle = document.createElement('button'); toggle.className='btn secondary'; toggle.textContent = u.disabled? 'Enable' : 'Disable';
      toggle.onclick = async ()=> { await db.collection('users').doc(u.id).update({ disabled: !u.disabled }); loadUsers(); };
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete'; del.onclick = async ()=> { if(!confirm('Delete user?')) return; await db.collection('users').doc(u.id).delete(); loadUsers(); };
      td.appendChild(toggle); td.appendChild(del);
      usersTableBody.appendChild(tr);
    });
  }catch(e){ console.error('loadUsers', e); usersTableBody.innerHTML = '<tr><td colspan="5">Failed to load</td></tr>'; }
}

// Add User modal handlers
const modalAddUser = document.getElementById('modal-add-user');
document.getElementById('btn-add-user')?.addEventListener('click', ()=> modalAddUser.style.display = 'flex');
document.getElementById('close-add-user')?.addEventListener('click', ()=> modalAddUser.style.display = 'none');

document.getElementById('create-user')?.addEventListener('click', async ()=>{
  if(!db) return alert('Firestore not configured');
  const username = document.getElementById('new-user-username').value.trim();
  const name = document.getElementById('new-user-name').value.trim();
  const password = document.getElementById('new-user-password').value.trim();
  const role = document.getElementById('new-user-role').value;
  if(!username || !password || !name) return alert('username, name and password are required');
  try{
    const existing = await db.collection('users').where('username','==',username).limit(1).get();
    if(!existing.empty) return alert('Username already exists');
    await db.collection('users').add({ username, name, password, role, disabled:false, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('new-user-username').value=''; document.getElementById('new-user-name').value=''; document.getElementById('new-user-password').value='';
    modalAddUser.style.display = 'none';
    loadUsers();
    alert('User created');
  }catch(e){ console.error('create user', e); alert('Failed to create user'); }
});

/* =========================
   RESULTS
   ========================= */
const resultsTableBody = document.querySelector('#results-table tbody');
async function loadResults(){
  if(!resultsTableBody) return;
  resultsTableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
  if(!db){ resultsTableBody.innerHTML = '<tr><td colspan="6">No DB configured</td></tr>'; return; }
  try{
    const snap = await db.collection('res').orderBy('date','desc').limit(200).get();
    resultsTableBody.innerHTML = '';
    if(snap.empty){ resultsTableBody.innerHTML = '<tr><td colspan="6">No results</td></tr>'; return; }
    snap.forEach(doc => {
      const r = doc.data(); r.id = doc.id;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(r.username||r.name||'-')}</td><td>${escapeHtml(r.mockId||'-')}</td><td>${r.score||0}</td><td>${r.date && r.date.toDate ? r.date.toDate().toLocaleString() : '-'}</td><td>${r.durationSec?Math.floor(r.durationSec/60)+'m':''}</td><td></td>`;
      const td = tr.cells[5];
      const view = document.createElement('button'); view.className='btn secondary'; view.textContent='View'; view.onclick = async ()=>{
        const docf = await db.collection('res').doc(r.id).get();
        showResultDetail(docf.data());
      };
      td.appendChild(view);
      resultsTableBody.appendChild(tr);
    });
  }catch(e){ console.error('loadResults', e); resultsTableBody.innerHTML = '<tr><td colspan="6">Failed to load</td></tr>'; }
}

function showResultDetail(d){
  const detailsEl = document.getElementById('attempt-details');
  detailsEl.innerHTML = '';
  if(!d) { detailsEl.textContent = 'No details'; return; }
  const header = document.createElement('div');
  header.innerHTML = `<strong>User:</strong> ${escapeHtml(d.username||d.name||'User')}<br><strong>Score:</strong> ${d.score||0}<br><strong>Duration:</strong> ${d.durationSec?Math.floor(d.durationSec/60)+'m '+(d.durationSec%60)+'s':''}`;
  detailsEl.appendChild(header);
  const list = document.createElement('div'); list.style.marginTop = '12px';
  (d.perQuestion||[]).forEach((p,i)=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='8px 6px'; el.style.borderBottom='1px solid rgba(0,0,0,0.04)';
    const left = document.createElement('div'); left.innerHTML = `<strong>${i+1}. ${escapeHtml(p.qid||'')}</strong><div class="small-muted">Time: ${p.timeUsedSec||0}s</div>`;
    const right = document.createElement('div'); right.innerHTML = `<div class="badge ${p.selectedIndex==null ? 'unseen' : (p.selectedIndex===p.correctIndex ? 'correct' : 'wrong')}">${p.selectedIndex==null? 'Unanswered' : (p.selectedIndex===p.correctIndex ? 'Correct' : 'Wrong')}</div><div style="margin-top:6px" class="small-muted">Selected: ${p.selectedIndex==null?'-':String.fromCharCode(65+p.selectedIndex)} • Correct: ${p.correctIndex==null?'-':String.fromCharCode(65+p.correctIndex)}</div>`;
    el.appendChild(left); el.appendChild(right); list.appendChild(el);
  });
  detailsEl.appendChild(list);
  document.getElementById('modal-attempt').style.display = 'flex';
}
document.getElementById('close-attempt')?.addEventListener('click', ()=> document.getElementById('modal-attempt').style.display = 'none');

/* =========================
   SETTINGS
   ========================= */
function loadSettings(){
  document.getElementById('setting-admin-name').value = document.getElementById('admin-name').textContent || 'Admin';
}
document.getElementById('save-settings')?.addEventListener('click', ()=>{
  const v = document.getElementById('setting-admin-name').value.trim();
  if(!v) return alert('Enter a name');
  document.getElementById('admin-name').textContent = v;
  alert('Saved');
});
document.getElementById('apply-theme')?.addEventListener('click', ()=>{
  const t = document.getElementById('setting-theme').value;
  if(t === 'dark'){
    document.documentElement.style.setProperty('--bg','#0b1220');
    document.documentElement.style.setProperty('--primary','#3ea6ff');
    document.body.style.color = '#e6eef8';
    alert('Dark theme applied (temporary)');
  } else {
    document.documentElement.style.setProperty('--bg','#f3f6fb');
    document.documentElement.style.setProperty('--primary','#1f78ff');
    document.body.style.color = '#0f172a';
    alert('Light theme applied');
  }
});

/* =========================
   UTIL / INIT
   ========================= */
// Filters
document.getElementById('filter-mocks')?.addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  Array.from(document.querySelectorAll('#mocks-table tbody tr')).forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});
document.getElementById('filter-results')?.addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  Array.from(document.querySelectorAll('#results-table tbody tr')).forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});
document.getElementById('filter-users')?.addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  Array.from(document.querySelectorAll('#users-table tbody tr')).forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
});

// initial view
showView('dashboard');

// If ?edit=ID present open builder with that mock
(function checkEditParam(){
  try{
    const params = new URL(location.href).searchParams;
    const edit = params.get('edit');
    if(edit) openMockInBuilder(edit);
  }catch(e){}
})();

// Initial loads when DB available
if(db){
  loadDashboard();
  loadMocksList();
  loadUsers();
  loadResults();
} else {
  console.warn('Firestore not configured; read/write will be console-only.');
}
</script>

</body>
</html>
