<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PYQs - Modal Fix (typing & QID editable) + Progress</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg: #f7f9f6;
      --surface: #ffffff;
      --muted-surface: #fbfdfb;
      --primary: #1db954;
      --accent: #16a34a;
      --text: #0b2a1a;
      --muted: #4a6b56;
      --muted-2: #6a8b6e;
      --input-border: rgba(13,120,73,0.12);
      --danger: #e03a3a;
      --radius:8px;
    }

    html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    :root { --gap:8px; --pad:8px; --fs-base:13px; }
    *{ box-sizing:border-box; font-size:var(--fs-base); color:var(--text); -webkit-font-smoothing:antialiased; }

    /* scale wrapper (only app content) */
    .app-scale {
      transform: scale(0.7);
      transform-origin: top left;
      width: 142%;
      overflow-x: hidden;
      position: relative;
      z-index: 1; /* below modal */
    }
    body.modal-active .app-scale { transform:none !important; width:100% !important; }

    .topbar { display:flex; gap:10px; align-items:center; padding:12px 14px; width:100%; background:transparent; }
    .controls { display:flex; gap:8px; align-items:center; width:100%; padding:6px 14px; flex-wrap:wrap; }
    .input, .select { padding:8px 10px; border-radius:8px; border:1px solid var(--input-border); background: var(--muted-surface); color:var(--text); font-size:13px; min-height:36px; box-sizing:border-box; }
    .input::placeholder{ color: rgba(11,42,26,0.38); }
    .btn{ background:linear-gradient(180deg,var(--primary),var(--accent)); color:#ffffff; padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:8px; box-shadow:0 8px 18px rgba(29,185,84,0.12); }
    .btn.secondary{ background:transparent; color:var(--muted-2); border:1px solid rgba(10,10,10,0.04); box-shadow:none; }
    .btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(10,10,10,0.04); box-shadow:none; }
    .small-muted{ font-size:12px; color:var(--muted); }

    .pyq-cards { display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); padding:6px 12px 60px 12px; }
    .pyq-card{ background: var(--surface); border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:8px; min-height:140px; border:1px solid rgba(10,10,10,0.04); box-shadow: 0 6px 18px rgba(14, 48, 30, 0.04); position:relative; overflow:visible; }
    .pyq-thumb{ height:96px; border-radius:6px; overflow:hidden; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, rgba(29,185,84,0.04), rgba(29,185,84,0.01)); border:1px solid rgba(29,185,84,0.04); }
    .pyq-thumb img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .pyq-meta{ display:flex; justify-content:space-between; gap:8px; align-items:center; font-size:12px; color:var(--muted); }
    .pyq-title{ font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text); }

    .cee-badge { position:absolute; left:10px; bottom:8px; font-size:11px; color: rgba(7, 44, 26, 0.75); font-weight:700; background: rgba(242,255,244,0.9); padding:4px 6px; border-radius:6px; border:1px solid rgba(10,10,10,0.02); }

    .icon-btn{ width:36px; height:34px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background:transparent; border:none; cursor:pointer; color:var(--muted-2); }
    .icon-btn:hover{ color:var(--primary); transform:translateY(-1px); }

    /* PREVIEW and modal */
    .preview-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:2100000; }
    .preview-card{ background: #ffffff; padding:12px; border-radius:10px; max-width:92%; max-height:86%; box-shadow:0 24px 80px rgba(0,0,0,0.12); display:flex; flex-direction:column; gap:8px; align-items:center; color:var(--text); border:1px solid rgba(10,10,10,0.04); }

    #modal-root { position: fixed; inset: 0; z-index:2147483647; display:none; pointer-events:auto; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
      pointer-events:auto;
      padding:20px;
      z-index:2147483647;
    }
    .modal-card {
      width: 880px;
      max-width: calc(100% - 40px);
      max-height: 80vh;
      background: var(--surface);
      padding: 0;
      border-radius:12px;
      box-shadow:0 24px 80px rgba(0,0,0,0.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      color: var(--text);
      z-index:2147483648;
    }
    .modal-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(10,10,10,0.04);
      background: linear-gradient(90deg, rgba(29,185,84,0.02), transparent);
      position: relative;
      z-index: 30;
    }
    .modal-body { padding: 12px 16px; flex: 1 1 auto; overflow-y: auto; background: transparent; }

    .records-table {
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:13px;
      color:var(--text);
      table-layout: fixed;
    }
    .records-table thead th {
      text-align:left;
      color:var(--muted-2);
      padding:8px;
      border-bottom:1px solid rgba(10,10,10,0.04);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 120;
      white-space:nowrap;
      font-weight:700;
    }
    .records-table th, .records-table td { padding:8px; border-bottom:1px solid rgba(10,10,10,0.03); vertical-align:middle; background:transparent; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }

    /* allow inputs to shrink and keep caret */
    .record-input { padding:8px 10px; border-radius:6px; border:1px solid var(--input-border); min-height:36px; font-size:13px; background: var(--surface); color:var(--text); width:100%; min-width:0; box-sizing:border-box; display:block; height:40px; line-height:20px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .record-input[readonly]{ background:#fbfbfb; }

    .abcd-group { display:flex; gap:6px; flex-wrap:nowrap; }
    .abcd-btn { padding:6px 8px; border-radius:6px; border:1px solid rgba(10,10,10,0.04); background:transparent; cursor:pointer; min-width:34px; text-align:center; font-weight:700; color:var(--muted); flex:0 0 auto; height:36px; line-height:18px; }
    .abcd-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    .row-remove { background:transparent; border:0; color:var(--danger); cursor:pointer; font-weight:700; }

    @media (max-width:920px){
      .modal-card { width: 94%; max-height: 86vh; }
      .pyq-cards { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
      .app-scale { transform: none; width:100%; }
      .records-table thead th { top:0; }
    }

    .no-scroll { overflow: hidden !important; height: 100%; }

    ::-webkit-scrollbar { height:10px; width:10px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(29,185,84,0.18), rgba(29,185,84,0.32)); border-radius:999px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .visually-hidden{ position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    /* --- Progress modal styles --- */
    #progress-root { position: fixed; inset: 0; z-index:2147483650; display:none; pointer-events:auto; }
    .progress-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; padding:12px; }
    .progress-card { width: calc(100% - 60px); max-width:1200px; height: 84vh; background: var(--surface); border-radius:10px; box-shadow:0 24px 80px rgba(0,0,0,0.12); display:flex; flex-direction:column; overflow:hidden; }
    .progress-header { padding:12px 14px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(10,10,10,0.04); }
    .progress-body { padding:12px; flex:1 1 auto; overflow:auto; }
    .progress-table { border-collapse:collapse; width:100%; table-layout: fixed; font-size:12px; }
    .progress-table th, .progress-table td { border:1px solid rgba(10,10,10,0.04); padding:6px; text-align:center; min-width:40px; vertical-align:middle; }
    .progress-table thead th { position: sticky; top:0; background:linear-gradient(180deg, rgba(255,255,255,0.9), var(--surface)); z-index:5; font-weight:700; }
    .cell-check { display:inline-flex; align-items:center; justify-content:center; width:100%; height:100%; padding:4px; }
    .cell-check svg{ width:16px; height:16px; }
    .cell-empty { color: rgba(11,42,26,0.15); font-weight:700; }
    .legend { display:flex; gap:12px; align-items:center; font-size:13px; color:var(--muted); }
    .legend .dot { width:14px; height:14px; border-radius:3px; display:inline-block; }
    .dot-ok{ background:var(--primary); }
    .dot-miss{ background:transparent; border:1px solid rgba(11,42,26,0.06); }
  </style>
</head>
<body>
  <!-- MODAL ROOT (existing) -->
  <div id="modal-root" aria-hidden="true">
    <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true">
      <div class="modal-card" role="document" aria-labelledby="add-pyq-title">
        <div class="modal-header">
          <h2 style="margin:0;font-size:16px" id="add-pyq-title">Add PYQ Records</h2>
          <div style="display:flex;gap:8px;align-items:center" class="top-actions">
            <button id="add-row-btn" class="btn ghost" title="Add new empty record" aria-label="Add row" style="padding:8px 10px; display:inline-flex; gap:8px; align-items:center;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
                <path d="M12 5v14"></path><path d="M5 12h14"></path>
              </svg>
              <span class="btn-label visually-hidden">Add row</span>
            </button>

            <button id="cancel-records" class="btn secondary" title="Cancel" aria-label="Cancel" style="padding:8px 10px; display:inline-flex; gap:8px; align-items:center;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
                <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
              </svg>
              <span class="btn-label visually-hidden">Cancel</span>
            </button>

            <button id="submit-records" class="btn" title="Submit records" aria-label="Add all" style="padding:8px 10px; display:inline-flex; gap:8px; align-items:center;">
              <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
                <path d="M20 6L9 17l-5-5"></path>
              </svg>
              <span class="btn-label">Add all</span>
            </button>
          </div>
        </div>

        <div class="modal-body" id="modal-body">
          <table class="records-table" id="records-table" role="grid" aria-label="PYQ records">
            <thead>
              <tr>
                <th style="width:36px">#</th>
                <th>Image URL</th>
                <th style="width:140px">Chapter</th>
                <th style="width:80px">Year</th>
                <th style="width:120px">Subject</th>
                <th style="width:120px">Correct</th>
                <th style="width:160px">QID (manual)</th>
                <th style="width:70px"></th>
              </tr>
            </thead>
            <tbody id="records-body"></tbody>
          </table>

          <div id="records-empty" class="small-muted" style="padding:10px; display:none">No rows yet. Click the + icon to create a record.</div>
          <div id="records-status" class="small-muted" style="margin-top:8px"></div>
          <div style="height:16px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROGRESS MODAL -->
  <div id="progress-root" aria-hidden="true">
    <div class="progress-backdrop" role="dialog" aria-modal="true">
      <div class="progress-card" role="document" aria-labelledby="progress-title">
        <div class="progress-header">
          <div style="display:flex;gap:12px;align-items:center;">
            <h3 id="progress-title" style="margin:0;font-size:15px">PYQ Progress — Question coverage (Q# 1–120)</h3>
            <div class="legend" style="margin-left:6px">
              <div style="display:flex;align-items:center;gap:6px"><span class="dot dot-ok"></span> Added</div>
              <div style="display:flex;align-items:center;gap:6px"><span class="dot dot-miss"></span> Missing</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="progress-status" class="small-muted">Loading...</div>
            <button id="close-progress" class="btn secondary" title="Close progress" aria-label="Close progress" style="padding:6px 8px; font-size:13px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="14" height="14" aria-hidden="true">
                <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="progress-body" id="progress-body">
          <!-- table will be inserted here -->
          <div class="small-muted">Preparing...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PREVIEW (existing) -->
  <div id="modal-preview" style="display:none; position:fixed; inset:0; z-index:2147483620; pointer-events:auto;">
    <div class="preview-backdrop" role="dialog" aria-modal="true">
      <div class="preview-card" role="document" aria-labelledby="preview-title">
        <div style="width:100%; display:flex; justify-content:flex-end;">
          <button id="close-preview" class="btn secondary" title="Close preview" aria-label="Close preview" style="padding:6px 8px; font-size:13px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="14" height="14" aria-hidden="true">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
            <span class="btn-label visually-hidden">Close</span>
          </button>
        </div>
        <div id="preview-body" style="width:100%; display:flex; align-items:center; justify-content:center; overflow:auto;"></div>
      </div>
    </div>
  </div>

  <!-- APP (existing) -->
  <div class="app-scale" id="app-scale">
    <main role="main" aria-label="PYQs Database - Light Emerald">
      <div class="topbar" style="align-items:flex-start;">
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btn-new-pyq" class="btn" title="Add PYQ" aria-label="Add PYQ" style="display:inline-flex; gap:8px; align-items:center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
              <path d="M12 5v14"></path><path d="M5 12h14"></path>
            </svg>
            <span class="btn-label visually-hidden">Add PYQ</span>
          </button>

          <button id="btn-refresh-pyqs" class="btn secondary" title="Refresh list" aria-label="Refresh" style="display:inline-flex; gap:8px; align-items:center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" aria-hidden="true">
              <path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M20.49 9A9 9 0 1 0 4 20.49"></path>
            </svg>
            <span class="btn-label visually-hidden">Refresh</span>
          </button>

          <!-- NEW: Progress button (icon only) -->
          <button id="btn-progress" class="btn ghost" title="Progress" aria-label="Progress" style="display:inline-flex; gap:6px; align-items:center; padding:8px;">
            <!-- compact progress / grid icon -->
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="3" width="7" height="7" rx="1"></rect>
              <rect x="14" y="3" width="7" height="7" rx="1"></rect>
              <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              <rect x="14" y="14" width="7" height="7" rx="1"></rect>
            </svg>
            <span class="visually-hidden">Progress</span>
          </button>

        </div>

        <div class="controls" style="margin-left:8px;">
          <select id="pyq-filter-subject" class="select" style="width:140px">
            <option value="">All subjects</option>
            <option>Physics</option><option>Chemistry</option><option>Mathematics</option>
          </select>

          <select id="pyq-filter-chapter" class="select" style="width:200px">
            <option value="">All chapters</option>
          </select>

          <input id="pyq-filter-year" class="input" placeholder="Year" style="width:96px"/>

          <input id="pyq-filter" class="input" placeholder="Search chapter, year, url..." style="min-width:240px; flex:1"/>

          <label class="small-muted" style="margin-left:6px; align-self:center">Sort</label>
          <select id="pyq-sort-by" class="select" style="width:140px;">
            <option value="createdAt">Created</option>
            <option value="year">Year</option>
          </select>

          <div class="sort-toggle" title="Toggle order (Asc / Desc)" style="margin-left:6px">
            <button id="sort-asc" class="active" aria-pressed="true" title="Ascending" style="width:30px;height:28px;border-radius:6px;background:transparent;border:1px solid rgba(10,10,10,0.04);">
              <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="#2fbf7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 15l7-7 7 7"/></svg>
            </button>
            <button id="sort-desc" aria-pressed="false" title="Descending" style="width:30px;height:28px;border-radius:6px;background:transparent;border:1px solid rgba(10,10,10,0.04); margin-left:6px;">
              <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="#2fbf7a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 9l-7 7-7-7"/></svg>
            </button>
          </div>

          <div class="small-muted" style="margin-left:10px">Total: <strong id="pyq-count">0</strong></div>
        </div>
      </div>

      <!-- Cards -->
      <div id="pyq-cards-wrapper" style="width:100%; padding:6px 8px 40px 8px;">
        <div class="pyq-cards" id="pyq-cards" aria-live="polite"></div>
      </div>
    </main>
  </div>

  <!-- FIREBASE SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /* FIREBASE CONFIG */
    const firebaseConfig = {
      apiKey: "AIzaSyBOVl1hdmprJXpgdN_sNTO3FsNePD_zNZY",
      authDomain: "aahes-cee-cutoffs.firebaseapp.com",
      projectId: "aahes-cee-cutoffs"
    };
    let db = null;
    try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); console.log('Firestore initialized'); } catch (e) { console.warn('Firestore init failed', e); }

    function el(id){ return document.getElementById(id); }
    function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
    function escapeHtml(str){ if(str==null) return ''; return String(str).replace(/[&<>"']/g, function(m){ return { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]; }); }

    const modalRoot = el('modal-root');
    const modalBackdrop = el('modal-backdrop');
    const modalBody = el('modal-body');
    const previewRoot = el('modal-preview');

    const records = [];
    let editingDocId = null;
    const pyqCardsContainer = el('pyq-cards');
    const pyqCountEl = el('pyq-count');
    const recordsBody = el('records-body');
    const recordsEmpty = el('records-empty');
    const recordsStatus = el('records-status');

    /* wiring */
    el('btn-new-pyq')?.addEventListener('click', ()=> openRecordsModal());
    el('btn-refresh-pyqs')?.addEventListener('click', ()=> loadPyqsList());
    el('pyq-filter')?.addEventListener('input', ()=> loadPyqsList());
    el('pyq-filter-subject')?.addEventListener('change', ()=> { populateChapterFilter(el('pyq-filter-subject').value); loadPyqsList(); });
    el('pyq-filter-chapter')?.addEventListener('change', ()=> loadPyqsList());
    el('pyq-filter-year')?.addEventListener('input', ()=> loadPyqsList());

    // Progress button wiring
    el('btn-progress')?.addEventListener('click', ()=> openProgressModal());
    el('close-progress')?.addEventListener('click', ()=> closeProgressModal());

    function setSortOrder(isAsc){
      if(isAsc){
        el('sort-asc').classList.add('active'); el('sort-asc').setAttribute('aria-pressed','true');
        el('sort-desc').classList.remove('active'); el('sort-desc').setAttribute('aria-pressed','false');
      } else {
        el('sort-desc').classList.add('active'); el('sort-desc').setAttribute('aria-pressed','true');
        el('sort-asc').classList.remove('active'); el('sort-asc').setAttribute('aria-pressed','false');
      }
    }
    el('sort-asc')?.addEventListener('click', ()=> { setSortOrder(true); loadPyqsList(); });
    el('sort-desc')?.addEventListener('click', ()=> { setSortOrder(false); loadPyqsList(); });

    el('add-row-btn')?.addEventListener('click', ()=> addRecordRow());
    el('cancel-records')?.addEventListener('click', ()=> { closeRecordsModal(); });
    el('submit-records')?.addEventListener('click', ()=> submitRecords());
    el('close-preview')?.addEventListener('click', ()=> closePreviewModal());

    function disablePageScroll(){ document.documentElement.classList.add('no-scroll'); document.body.classList.add('no-scroll'); }
    function enablePageScroll(){ document.documentElement.classList.remove('no-scroll'); document.body.classList.remove('no-scroll'); }

    function openRecordsModal(editDoc){
      // reset state
      records.length = 0;
      editingDocId = null;
      recordsBody.innerHTML = '';
      recordsStatus.textContent = '';

      modalRoot.style.display = 'block';
      modalRoot.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-active');
      disablePageScroll();

      if(editDoc && editDoc.id){
        editingDocId = editDoc.id;
        addRecordRow({
          imageUrl: editDoc.imageUrl || '',
          chapter: editDoc.chapter || '',
          year: editDoc.year || '',
          subject: editDoc.subject || 'Physics',
          correct: editDoc.correct || '',
          qid: editDoc.qid || ''
        });
        el('add-pyq-title').textContent = 'Edit PYQ';
        const lbl = el('submit-records').querySelector('.btn-label');
        if(lbl) lbl.textContent = 'Save';
        el('add-row-btn').style.display = 'none';
      } else {
        el('add-pyq-title').textContent = 'Add PYQ Records';
        const lbl = el('submit-records').querySelector('.btn-label');
        if(lbl) lbl.textContent = 'Add all';
        el('add-row-btn').style.display = '';
        addRecordRow(); // create blank row but do NOT auto-generate qid
      }

      setTimeout(()=> {
        const first = modalRoot.querySelector('.record-input');
        if(first) first.focus();
      }, 40);
      renderRecords();
    }

    function closeRecordsModal(){
      modalRoot.style.display = 'none';
      modalRoot.setAttribute('aria-hidden','true');
      records.length = 0;
      editingDocId = null;
      recordsBody.innerHTML = '';
      document.body.classList.remove('modal-active');
      enablePageScroll();
    }
function getLastRecordDefaults(){
  if(records.length === 0) return null;

  const last = records[records.length - 1];

  return {
    year: last.year || '',
    subject: last.subject || 'Physics',
    qid: last.qid || ''
  };
}

function getNextNumericQid(prevQid){
  if(!prevQid) return '';
  if(!/^\d+$/.test(String(prevQid).trim())) return '';
  return String(parseInt(prevQid, 10) + 1);
}

    function addRecordRow(prefill){
  const defaults = getLastRecordDefaults();

  const tmpId = 'r' + Math.random().toString(36).slice(2,9);

  const rec = {
    imageUrl: prefill?.imageUrl || '',
    chapter: prefill?.chapter || '',
    year: prefill?.year 
          || defaults?.year 
          || '',
    subject: prefill?.subject 
          || defaults?.subject 
          || 'Physics',
    correct: prefill?.correct || '',
    qid: prefill?.qid 
        || getNextNumericQid(defaults?.qid),
    tmpId
  };

  records.push(rec);

  renderRecords();

  setTimeout(()=> {
    const rowEl = document.getElementById('row-'+tmpId);
    if(rowEl) rowEl.scrollIntoView({ behavior:'smooth', block:'center' });
  }, 80);

  return rec;
}


    function removeRecordRow(tmpId){
      const idx = records.findIndex(r => r.tmpId === tmpId);
      if(idx === -1) return;
      records.splice(idx,1);
      renderRecords();
    }

    function renderRecords(){
      // re-render rows (only called on structural changes like add/remove or after submit)
      recordsBody.innerHTML = '';
      if(records.length === 0){
        recordsEmpty.style.display = '';
      } else {
        recordsEmpty.style.display = 'none';
      }
      records.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.id = 'row-'+r.tmpId;
        tr.innerHTML = `
          <td style="width:36px; padding:6px; font-weight:700">${i+1}</td>
          <td style="padding:6px;">
            <input class="record-input" data-field="imageUrl" data-id="${r.tmpId}" placeholder="https://..." value="${escapeHtml(r.imageUrl)}" style="width:100%"/>
          </td>
          <td style="padding:6px;"><input class="record-input" data-field="chapter" data-id="${r.tmpId}" value="${escapeHtml(r.chapter)}" placeholder="Chapter" style="width:100%"/></td>
          <td style="padding:6px;"><input class="record-input" data-field="year" data-id="${r.tmpId}" value="${escapeHtml(r.year)}" placeholder="Year" style="width:100%"/></td>
          <td style="padding:6px;">
            <select class="record-input" data-field="subject" data-id="${r.tmpId}" style="width:100%">
              <option ${r.subject==='Physics' ? 'selected':''}>Physics</option>
              <option ${r.subject==='Chemistry' ? 'selected':''}>Chemistry</option>
              <option ${r.subject==='Mathematics' ? 'selected':''}>Mathematics</option>
            </select>
          </td>
          <td style="padding:6px;">
            <div class="abcd-group" data-id="${r.tmpId}">
              <button type="button" class="abcd-btn ${r.correct==='A' ? 'active':''}" data-opt="A" data-id="${r.tmpId}">A</button>
              <button type="button" class="abcd-btn ${r.correct==='B' ? 'active':''}" data-opt="B" data-id="${r.tmpId}">B</button>
              <button type="button" class="abcd-btn ${r.correct==='C' ? 'active':''}" data-opt="C" data-id="${r.tmpId}">C</button>
              <button type="button" class="abcd-btn ${r.correct==='D' ? 'active':''}" data-opt="D" data-id="${r.tmpId}">D</button>
            </div>
          </td>
          <td style="padding:6px;"><input class="record-input" data-field="qid" data-id="${r.tmpId}" value="${escapeHtml(r.qid)}" placeholder="Type QID (manual) or leave blank" style="width:100%"/></td>
          <td style="padding:6px; text-align:center;"><button class="row-remove" data-id="${r.tmpId}" title="Remove row" aria-label="Remove row">✕</button></td>
        `;
        recordsBody.appendChild(tr);
      });

      // attach event handlers once (and rely on in-place edits)
      // inputs: we use 'input' listeners but DO NOT re-render the whole table on each input.
      qsa('.record-input').forEach(inp=>{
        // avoid duplicate listeners
        inp.removeEventListener('input', recordInputHandler);
        inp.addEventListener('input', recordInputHandler);
      });
      // abcd buttons - toggle classes and set model without re-render
      qsa('.abcd-btn').forEach(b=>{
        b.removeEventListener('click', abcdClickHandler);
        b.addEventListener('click', abcdClickHandler);
      });
      qsa('.row-remove').forEach(b=>{
        b.removeEventListener('click', rowRemoveHandler);
        b.addEventListener('click', rowRemoveHandler);
      });
    }

    // IMPORTANT: do NOT call renderRecords() inside this handler to avoid losing caret.
    function recordInputHandler(e){
      const id = e.target.dataset.id;
      const field = e.target.dataset.field;
      const rec = records.find(r => r.tmpId === id);
      if(!rec) return;
      // update model in-place
      rec[field] = e.target.value;
      // if user changes subject, we do NOT auto-change qid. keep qid manual.
      // only call renderRecords on structural changes (add/remove) or when necessary.
    }

    function abcdClickHandler(e){
      const id = e.currentTarget.dataset.id;
      const opt = e.currentTarget.dataset.opt;
      // update model
      const rec = records.find(r => r.tmpId === id);
      if(!rec) return;
      rec.correct = opt;
      // update button classes in DOM directly (no re-render)
      const group = document.querySelector(`.abcd-group[data-id="${id}"]`);
      if(group){
        group.querySelectorAll('.abcd-btn').forEach(btn => btn.classList.remove('active'));
        e.currentTarget.classList.add('active');
      }
    }

    function rowRemoveHandler(e){
      const id = e.currentTarget.dataset.id;
      removeRecordRow(id);
    }

    /* QID generation helper (used only at submit time if qid left blank) */
    function generateBatchQIDsFor(recordsArray){
      const suffix = String(Date.now()).slice(-6);
      return recordsArray.map((r, idx) => {
        const initial = (r.subject && r.subject[0]) ? String(r.subject[0]).toUpperCase() : 'X';
        const index = String(idx+1).padStart(2, '0');
        return `${initial}${suffix}${index}`;
      });
    }

    /* Submit records - generate QIDs only for rows that have no qid (so manual QID preserved) */
    async function submitRecords(){
      const submitBtn = el('submit-records');
      const submitLabel = submitBtn.querySelector('.btn-label');
      if(editingDocId){
        if(records.length === 0) return alert('No record to save');
        const r = records[0];
        if(!r.imageUrl) return alert('Image URL required');
        try{
          if(submitLabel) submitLabel.textContent = 'Saving...';
          submitBtn.disabled = true;
          const docRef = db.collection('pyqs').doc(editingDocId);
          const docSnap = await docRef.get();
          let existingQid = '';
          if(docSnap.exists){
            existingQid = docSnap.data().qid || '';
          }
          // prefer existingQid (existing doc), then user-typed qid, then auto-generate
          const qidToWrite = existingQid || (r.qid && r.qid.trim() ? r.qid.trim() : generateBatchQIDsFor([r])[0]);

          await docRef.update({
            imageUrl: r.imageUrl,
            chapter: r.chapter || '',
            year: r.year || '',
            subject: r.subject || '',
            correct: r.correct || '',
            qid: qidToWrite,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          closeRecordsModal();
          loadPyqsList();
        }catch(e){ console.error('update pyq', e); alert('Update failed'); }
        finally { submitBtn.disabled = false; if(submitLabel) submitLabel.textContent = 'Save'; }
      } else {
        if(records.length === 0) return alert('No records to add');
        const invalid = records.find(r=> !r.imageUrl || r.imageUrl.trim()==='');
        if(invalid) return alert('Every row must have an Image URL');
        try{
          if(submitLabel) submitLabel.textContent = 'Adding...';
          submitBtn.disabled = true;

          // generate QIDs only for rows that don't have one (preserve manual)
          const missingIdxs = [];
          const toGenerate = [];
          records.forEach((r, idx) => {
            if(!r.qid || String(r.qid).trim()===''){
              missingIdxs.push(idx);
              toGenerate.push({...r, subject: r.subject || 'X'});
            }
          });
          const generated = generateBatchQIDsFor(toGenerate);
          missingIdxs.forEach((origIdx, j)=>{
            records[origIdx].qid = generated[j];
          });

          if(db && db.collection){
            await Promise.all(records.map((r) => {
              const doc = {
                imageUrl: r.imageUrl,
                chapter: r.chapter || '',
                year: r.year || '',
                subject: r.subject || '',
                correct: r.correct || '',
                qid: r.qid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              };
              return db.collection('pyqs').add(doc);
            }));
          } else {
            console.log('Would add records with QIDs:', records.map((r)=> ({...r})));
          }
          recordsStatus.textContent = `Added ${records.length} records`;
          closeRecordsModal();
          loadPyqsList();
        }catch(e){ console.error('add records', e); alert('Add failed: '+ (e.message || e)); }
        finally { submitBtn.disabled = false; if(submitLabel) submitLabel.textContent = 'Add all'; }
      }
    }

    /* Preview helpers */
    function openPreviewModal(imageUrl, title){
      previewRoot.style.display = 'block';
      disablePageScroll();
      const body = el('preview-body');
      body.innerHTML = `<div style="max-width:100%;max-height:100%;display:flex;align-items:center;justify-content:center"><img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(title||'PYQ')}" style="max-width:92vw;max-height:80vh;display:block;border-radius:6px; background:#fff" onerror="this.style.opacity=.4;"/></div>`;
    }
    function closePreviewModal(){
      previewRoot.style.display = 'none';
      enablePageScroll();
      el('preview-body').innerHTML = '';
    }

    /* Helper: extract question number from QID (tries several heuristics)
       - Preferred: trailing 1-3 digits at end of QID (e.g. P12345601 -> 1)
       - Else: any 1-3 digit number inside QID (first/best candidate)
       - Returns integer or null if can't find */
    function extractQNoFromQid(qid){
      if(!qid || typeof qid !== 'string') return null;
      // Trim and remove non-printable
      const s = qid.trim();
      // 1) trailing digits (1-3)
      let m = s.match(/(\d{1,3})$/);
      if(m) {
        const v = parseInt(m[1], 10);
        if(!isNaN(v) && v >= 1 && v <= 120) return v;
      }
      // 2) look for a group like '_12' or '-12' or 'q12' etc.
      m = s.match(/(?:_|-|\b|q|Q)(\d{1,3})\b/);
      if(m){
        const v = parseInt(m[1], 10);
        if(!isNaN(v) && v >= 1 && v <= 120) return v;
      }
      // 3) any 1-3 digits anywhere - choose the last occurrence (often question number at end)
      const all = s.match(/\d{1,3}/g);
      if(all && all.length){
        for(let i = all.length - 1; i >= 0; --i){
          const v = parseInt(all[i], 10);
          if(!isNaN(v) && v >= 1 && v <= 120) return v;
        }
      }
      return null;
    }

    /* Helper: try to determine year for a document.
       Priority:
         1) doc.year field if numeric and between 2017-2025
         2) 4-digit year inside qid (2017-2025)
         3) null */
    function extractYearFromDoc(d){
      const years = [];
      if(d && d.year){
        const y = parseInt(String(d.year).trim().slice(0,4), 10);
        if(!isNaN(y)) years.push(y);
      }
      if(d && d.qid && typeof d.qid === 'string'){
        const m = d.qid.match(/(20(1[7-9]|2[0-5]))/); // 2017-2025
        if(m) years.push(parseInt(m[1],10));
      }
      // also allow year from createdAt if present (firestore Timestamp)
      if(d && d.createdAt && d.createdAt.toDate){
        try{
          const dt = d.createdAt.toDate();
          const y = dt.getFullYear();
          if(y >= 2017 && y <= 2025) years.push(y);
        }catch(e){}
      }
      // return first valid year
      for(const y of years){
        if(y >= 2017 && y <= 2025) return y;
      }
      return null;
    }

    /* PROGRESS modal: build a map year->Set(qNos) and render table 1..120 */
    async function openProgressModal(){
      const root = el('progress-root');
      const body = el('progress-body');
      const status = el('progress-status');
      root.style.display = 'block';
      root.setAttribute('aria-hidden','false');
      disablePageScroll();
      body.innerHTML = `<div class="small-muted">Loading data…</div>`;
      status.textContent = 'Loading…';

      // years columns 2025 down to 2017
      const years = [];
      for(let y = 2025; y >= 2017; y--) years.push(y);

      // prepare map: year -> Set of qnos
      const map = new Map();
      years.forEach(y => map.set(y, new Set()));

      try{
        if(!db){
          body.innerHTML = `<div class="small-muted">No DB configured</div>`;
          status.textContent = 'No DB';
          return;
        }
        const snap = await db.collection('pyqs').get();
        snap.forEach(doc => {
          const d = doc.data();
          // determine year
          let y = extractYearFromDoc(d);
          // if doc.year is string like '2025' it's handled in extractYearFromDoc
          // determine qno from qid preferred; if no qid, we might try to read from doc.qno or doc.qNo field if exists
          let qno = null;
          if(d && d.qid) qno = extractQNoFromQid(d.qid);
          if(!qno && d && (d.qNo || d.qno || d.q_num)){
            const alt = parseInt(String(d.qNo || d.qno || d.q_num).trim(), 10);
            if(!isNaN(alt) && alt >=1 && alt <=120) qno = alt;
          }
          // fallback: if year not in range but doc.year present numeric, coerce if in range
          if(y === null && d && d.year){
            const yy = parseInt(String(d.year).trim(), 10);
            if(!isNaN(yy) && yy>=2017 && yy<=2025) y = yy;
          }
          // Mark if both year and qno are valid
          if(y !== null && qno !== null && map.has(y)){
            map.get(y).add(qno);
          }
        });

        // render table
        const table = document.createElement('table');
        table.className = 'progress-table';
        // header
        const thead = document.createElement('thead');
        const htr = document.createElement('tr');
        htr.innerHTML = `<th style="min-width:48px">Q#</th>` + years.map(y => `<th>${y}</th>`).join('');
        thead.appendChild(htr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        // rows 1..120
        for(let q=1;q<=120;q++){
          const tr = document.createElement('tr');
          const firstTd = document.createElement('td');
          firstTd.textContent = q;
          firstTd.style.fontWeight = '700';
          tr.appendChild(firstTd);

          years.forEach(y => {
            const td = document.createElement('td');
            if(map.get(y).has(q)){
              td.innerHTML = `<div class="cell-check" title="Present"><svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="background:${getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#1db954'}; border-radius:4px; padding:2px"><path d="M20 6L9 17l-5-5"></path></svg></div>`;
            } else {
              td.innerHTML = `<div class="cell-empty">—</div>`;
            }
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }
        table.appendChild(tbody);

        body.innerHTML = '';
        body.appendChild(table);

        status.textContent = `Showing coverage for ${years.length} years`;
      }catch(e){
        console.error('openProgressModal', e);
        body.innerHTML = `<div class="small-muted">Failed to load progress: ${escapeHtml(e.message || String(e))}</div>`;
        status.textContent = 'Failed';
      }
    }

    function closeProgressModal(){
      const root = el('progress-root');
      root.style.display = 'none';
      root.setAttribute('aria-hidden','true');
      enablePageScroll();
      el('progress-body').innerHTML = '';
      el('progress-status').textContent = '';
    }

    /* Listing / filters (unchanged) */
    async function populateChapterFilter(subject){
      const chapterSelect = el('pyq-filter-chapter');
      chapterSelect.innerHTML = `<option value="">All chapters</option>`;
      if(!db) return;
      try{
        let q = db.collection('pyqs');
        if(subject) q = q.where('subject','==',subject);
        const snap = await q.get();
        const chapters = new Set();
        snap.forEach(d=>{
          const ch = (d.data().chapter || '').trim();
          if(ch) chapters.add(ch);
        });
        Array.from(chapters).sort().forEach(ch => {
          const opt = document.createElement('option'); opt.value = ch; opt.textContent = ch;
          chapterSelect.appendChild(opt);
        });
      }catch(e){ console.error('populateChapterFilter', e); }
    }

    function openAddPyqModal(editDoc){
      openRecordsModal(editDoc);
    }

    async function loadPyqsList(){
      if(!pyqCardsContainer) return;
      pyqCardsContainer.innerHTML = `<div class="small-muted" style="padding:12px">Loading...</div>`;
      if(!db){ pyqCardsContainer.innerHTML = '<div class="small-muted" style="padding:12px">No DB configured</div>'; pyqCountEl.textContent='0'; return; }

      try{
        let q = db.collection('pyqs');
        const sortBy = el('pyq-sort-by')?.value || 'createdAt';
        const sortAsc = el('sort-asc').classList.contains('active');

        const snap = await q.get();
        const rows = [];
        const fsub = el('pyq-filter-subject').value;
        const fchap = el('pyq-filter-chapter').value;
        const fyear = el('pyq-filter-year').value.trim();
        const qtext = el('pyq-filter').value.trim().toLowerCase();

        snap.forEach(doc => {
          const d = doc.data(); d.id = doc.id;
          if(fsub && d.subject !== fsub) return;
          if(fchap && String((d.chapter||'')).toLowerCase() !== String((fchap||'')).toLowerCase()) return;
          if(fyear && String(d.year||'').indexOf(String(fyear)) === -1) return;
          if(qtext){
            const hay = `${d.chapter||''} ${d.year||''} ${d.subject||''} ${d.imageUrl||''} ${d.qid||''}`.toLowerCase();
            if(!hay.includes(qtext)) return;
          }
          rows.push(d);
        });

        rows.sort((a,b)=>{
          let va = a[sortBy], vb = b[sortBy];
          if(sortBy === 'createdAt'){
            va = va && va.toDate ? va.toDate().getTime() : (va ? new Date(va).getTime() : 0);
            vb = vb && vb.toDate ? vb.toDate().getTime() : (vb ? new Date(vb).getTime() : 0);
          } else {
            const na = Number(va), nb = Number(vb);
            if(!isNaN(na) && !isNaN(nb)) { va = na; vb = nb; }
            else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }
          }
          if(va < vb) return sortAsc ? -1 : 1;
          if(va > vb) return sortAsc ? 1 : -1;
          return 0;
        });

        pyqCardsContainer.innerHTML = '';
        if(rows.length === 0){
          pyqCardsContainer.innerHTML = `<div class="small-muted" style="padding:12px">No PYQs found</div>`;
          pyqCountEl.textContent = '0';
          return;
        }
        pyqCountEl.textContent = rows.length;

        rows.forEach(d=>{
          const card = document.createElement('div'); card.className = 'pyq-card';
          const thumb = document.createElement('div'); thumb.className = 'pyq-thumb';
          const img = document.createElement('img');
          img.src = d.imageUrl || '';
          img.alt = d.chapter || 'PYQ';
          img.onerror = function(){ this.style.opacity = '0.45'; this.style.filter='grayscale(80%)'; };
          thumb.appendChild(img);

          const title = document.createElement('div'); title.className = 'pyq-title'; title.textContent = d.chapter || (d.subject || '') + ' PYQ';

          const meta = document.createElement('div'); meta.className = 'pyq-meta';
          const leftMeta = document.createElement('div'); leftMeta.textContent = d.year || '-';
          const rightMeta = document.createElement('div'); rightMeta.textContent = d.subject || '-';
          meta.appendChild(leftMeta); meta.appendChild(rightMeta);

          if(d.correct){
            const correctBadge = document.createElement('div'); correctBadge.className='small-muted'; correctBadge.textContent = 'Answer: ' + d.correct;
            correctBadge.style.marginLeft = '8px';
            meta.appendChild(correctBadge);
          }

          if(d.qid){
            const qidBadge = document.createElement('div'); qidBadge.className='small-muted'; qidBadge.textContent = 'QID: ' + d.qid;
            qidBadge.style.marginLeft = '8px';
            meta.appendChild(qidBadge);
          }

          const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.justifyContent='flex-end';

          const eyeBtn = document.createElement('button'); eyeBtn.className='icon-btn'; eyeBtn.title = 'View';
          eyeBtn.innerHTML = `<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="#2fbf7a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8S1 12 1 12z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>`;
          eyeBtn.addEventListener('click', ()=> openPreviewModal(d.imageUrl || '', d.chapter || ''));

          const editBtn = document.createElement('button'); editBtn.className = 'icon-btn'; editBtn.title='Edit';
          editBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="#2fbf7a" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="16" height="16">
            <path d="M3 21v-3.6a2 2 0 0 1 .6-1.4L17 3.6a2 2 0 0 1 2.8 0l.6.6a2 2 0 0 1 0 2.8L6.6 21.4A2 2 0 0 1 5.2 22H3z"></path>
          </svg>`;
          editBtn.addEventListener('click', ()=> {
            openAddPyqModal({ id: d.id, imageUrl: d.imageUrl, chapter: d.chapter, year: d.year, subject: d.subject, correct: d.correct, qid: d.qid });
          });

          const delBtn = document.createElement('button'); delBtn.className = 'icon-btn'; delBtn.title='Delete';
          delBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="${'#e03a3a'}" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="16" height="16">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
            <path d="M10 11v6"></path>
            <path d="M14 11v6"></path>
            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
          </svg>`;
          delBtn.addEventListener('click', async ()=> {
            if(!confirm('Delete this PYQ?')) return;
            try{
              await db.collection('pyqs').doc(d.id).delete();
              loadPyqsList();
            }catch(e){ console.error('delete pyq', e); alert('Delete failed'); }
          });

          actions.appendChild(eyeBtn);
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);

          const badge = document.createElement('div'); badge.className = 'cee-badge'; badge.textContent = 'CEE ASSAM';

          card.appendChild(thumb);
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(actions);
          card.appendChild(badge);

          pyqCardsContainer.appendChild(card);
        });

        populateChapterFilter(el('pyq-filter-subject').value);
      }catch(e){
        console.error('loadPyqsList', e);
        pyqCardsContainer.innerHTML = '<div class="small-muted" style="padding:12px">Failed to load</div>';
        pyqCountEl.textContent='0';
      }
    }

    // initial
    setSortOrder(true);
    populateChapterFilter('');
    loadPyqsList();

  </script>
</body>
</html>
